<% content_for :title, "Shopping Cart" %>

<div class="cart-page">
  <div class="container mx-auto px-4 py-8">

    <!-- Page Header -->
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Shopping Cart</h1>
      <%= link_to "Continue Shopping", products_path,
                 class: "text-blue-600 hover:text-blue-800 font-medium" %>
    </div>

    <% if @order_items.any? %>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Cart Items -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">
                Cart Items (<%= pluralize(@order_items.sum(&:quantity), 'item') %>)
              </h2>
            </div>

            <div class="divide-y divide-gray-200">
              <% @order_items.each do |item| %>
                <div class="p-6 flex items-center space-x-4" data-order-item-id="<%= item.id %>">

                  <!-- Product Image -->
                  <div class="flex-shrink-0">
                    <%= link_to product_path(item.product), data: { turbo_frame: "_top" } do %>
                      <% if item.product.image_url.present? %>
                        <%= image_tag item.product.image_url,
                                     alt: item.product.name,
                                     class: "h-20 w-20 object-cover rounded-md" %>
                      <% else %>
                        <div class="h-20 w-20 bg-gray-200 rounded-md flex items-center justify-center">
                          <svg class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                        </div>
                      <% end %>
                    <% end %>
                  </div>

                  <!-- Product Details -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between">
                      <div>
                        <h3 class="text-base font-medium text-gray-900">
                          <%= link_to item.product.name, product_path(item.product),
                                     class: "hover:text-blue-600",
                                     data: { turbo_frame: "_top" } %>
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">
                          <%= item.product.category %>
                        </p>
                        <p class="text-sm font-medium text-gray-900 mt-1">
                          <%= item.formatted_unit_price %> each
                        </p>
                      </div>

                      <!-- Remove Item Button -->
                      <%= button_to remove_item_orders_path,
                                   method: :delete,
                                   params: { order_item_id: item.id },
                                   data: {
                                     confirm: "Remove #{item.product.name} from cart?",
                                     turbo_method: :delete
                                   },
                                   class: "text-red-600 hover:text-red-800 text-sm" do %>
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      <% end %>
                    </div>

                    <!-- Quantity and Price -->
                    <div class="flex items-center justify-between mt-4">
                      <div class="flex items-center space-x-2">
                        <label for="quantity_<%= item.id %>" class="text-sm text-gray-700">Qty:</label>

                        <%= form_with url: update_item_orders_path,
                                     method: :patch,
                                     local: true,
                                     data: { controller: "auto-submit" },
                                     class: "inline-flex items-center" do |form| %>
                          <%= form.hidden_field :order_item_id, value: item.id %>
                          <%= form.number_field :quantity,
                                               value: item.quantity,
                                               min: 1,
                                               max: [item.product.stock_quantity, 20].min,
                                               id: "quantity_#{item.id}",
                                               class: "w-16 px-2 py-1 border border-gray-300 rounded text-center text-sm",
                                               data: { action: "change->auto-submit#submit" } %>
                        <% end %>

                        <span class="text-xs text-gray-500">
                          (<%= item.product.stock_quantity %> available)
                        </span>
                      </div>

                      <div class="text-right">
                        <p class="text-lg font-semibold text-gray-900">
                          <%= item.formatted_total_price %>
                        </p>
                      </div>
                    </div>

                    <!-- Stock Warning -->
                    <% unless item.product.available_stock?(item.quantity) %>
                      <div class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded">
                        ⚠️ Only <%= item.product.stock_quantity %> items available. Please reduce quantity.
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 sticky top-4">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-semibold text-gray-900">Order Summary</h2>
            </div>

            <div class="p-6 space-y-4">
              <!-- Subtotal -->
              <div class="flex justify-between text-base">
                <span class="text-gray-700">Subtotal (<%= pluralize(@order_items.sum(&:quantity), 'item') %>)</span>
                <span class="font-medium text-gray-900">
                  $<%= '%.2f' % @order_items.sum(&:total_price) %>
                </span>
              </div>

              <!-- Shipping -->
              <div class="flex justify-between text-base">
                <span class="text-gray-700">Shipping</span>
                <span class="font-medium text-gray-900">
                  <span class="text-green-600">FREE</span>
                </span>
              </div>

              <!-- Free shipping progress -->
              <% if @order_items.sum(&:total_price) < 50 %>
                <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded">
                  <p class="font-medium">Add $<%= '%.2f' % (50 - @order_items.sum(&:total_price)) %> more for FREE shipping!</p>
                  <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: <%= [(@order_items.sum(&:total_price) / 50.0 * 100), 100].min %>%"></div>
                  </div>
                </div>
              <% end %>

              <!-- Tax -->
              <div class="flex justify-between text-base">
                <span class="text-gray-700">Estimated Tax</span>
                <span class="font-medium text-gray-900">
                  $<%= '%.2f' % (@order_items.sum(&:total_price) * 0.08) %>
                </span>
              </div>

              <div class="border-t pt-4">
                <div class="flex justify-between text-lg font-semibold">
                  <span class="text-gray-900">Total</span>
                  <span class="text-gray-900">
                    <%
                      subtotal = @order_items.sum(&:total_price)
                      shipping = subtotal >= 50 ? 0 : 9.99
                      tax = subtotal * 0.08
                      total = subtotal + shipping + tax
                    %>
                    $<%= '%.2f' % total %>
                  </span>
                </div>
              </div>

              <!-- Checkout Button -->
              <div class="mt-6">
                <%= link_to "Proceed to Checkout", checkout_path,
                           class: "w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center block transition-colors duration-200" %>
              </div>

              <!-- PayPal Button (Optional) -->
              <div class="mt-3">
                <button class="w-full bg-yellow-400 text-gray-900 px-6 py-3 rounded-lg font-medium hover:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-colors duration-200">
                  Pay with PayPal
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    <% else %>
      <!-- Empty Cart -->
      <div class="text-center py-12">
        <svg class="mx-auto h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.1 5H19M7 13v8a2 2 0 002 2h10a2 2 0 002-2v-8m-9 4h4" />
        </svg>

        <h2 class="mt-4 text-2xl font-semibold text-gray-900">Your cart is empty</h2>
        <div class="mt-2 mb-4 text-gray-600">Start shopping to add items to your cart</div>

        <div class="mt-8">
          <%= link_to "Shop Products", products_path,
                     class: "bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" %>
        </div>
      </div>
    <% end %>

    <!-- Recently Viewed (Optional) -->
    <% if @order_items.any? %>
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">You might also like</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          <% Product.active.limit(4).each do |product| %>
            <%= render "products/product_card", product: product %>
          <% end %>
        </div>
      </div>
    <% end %>

  </div>
</div>

<!-- Auto-submit Stimulus Controller -->
<script>
  // This will be moved to a proper Stimulus controller
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('[data-controller="auto-submit"]');
    forms.forEach(form => {
      const input = form.querySelector('input[type="number"]');
      if (input) {
        input.addEventListener('change', function() {
          form.submit();
        });
      }
    });
  });
</script>
